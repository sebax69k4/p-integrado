---
import MainLayout from '../../layouts/MainLayout.astro';
import { getUsuariosPendientes } from '../../lib/strapi';

const token = Astro.cookies.get('jwt')?.value;

if (!token) {
  return Astro.redirect('/login');
}

let usuarios = [];
try {
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">RUT</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Razón Social</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Giro</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {usuarios.map((user: any) => (
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{user.rut}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.razon_social}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{user.giro}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <div>{user.email}</div>
                  <div>{user.telefono}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <button 
                    onclick={`openApproveModal('${user.id}', '${user.razon_social}')`}
                    class="text-green-600 hover:text-green-900 mr-4"
                  >
                    Aprobar
                  </button>
                  <button 
                    onclick={`rejectUser('${user.id}')`}
                    class="text-red-600 hover:text-red-900"
                  >
                    Rechazar
                  </button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    )}
  </div>

  <!-- Modal Aprobar -->
  <div id="approve-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Aprobar Usuario</h3>
        <div class="mt-2 px-7 py-3">
          <p class="text-sm text-gray-500 mb-4">
            Selecciona la lista de precios para <span id="modal-username" class="font-bold"></span>
          </p>
          <select id="price-list-select" class="w-full border rounded px-3 py-2 mb-4">
            <option value="estandar">Lista Estándar</option>
            <option value="empresa">Lista Empresa</option>
          </select>
        </div>
        <div class="items-center px-4 py-3">
          <button id="confirm-approve-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
            Confirmar Aprobación
          </button>
          <button onclick="closeApproveModal()" class="mt-3 px-4 py-2 bg-gray-100 text-gray-700 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-300">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUserId: string | null = null;
    const modal = document.getElementById('approve-modal');
    const modalUsername = document.getElementById('modal-username');
    const confirmBtn = document.getElementById('confirm-approve-btn');
    const priceListSelect = document.getElementById('price-list-select') as HTMLSelectElement;

    // @ts-ignore
    window.openApproveModal = (userId: string, username: string) => {
      currentUserId = userId;
      if (modalUsername) modalUsername.textContent = username;
      modal?.classList.remove('hidden');
    };

    // @ts-ignore
    window.closeApproveModal = () => {
      modal?.classList.add('hidden');
      currentUserId = null;
    };

    // @ts-ignore
    window.rejectUser = async (userId: string) => {
      if (!confirm('¿Estás seguro de que deseas rechazar a este usuario? Esta acción no se puede deshacer.')) return;

      try {
        const res = await fetch('/api/admin/validate-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, action: 'reject' })
        });

        if (res.ok) {
          alert('Usuario rechazado correctamente');
          window.location.reload();
        } else {
          alert('Error al rechazar usuario');
        }
      } catch (error) {
        console.error(error);
        alert('Error al rechazar usuario');
      }
    };

    confirmBtn?.addEventListener('click', async () => {
      if (!currentUserId) return;
      
      const listaPrecios = priceListSelect?.value;

      try {
        const res = await fetch('/api/admin/validate-user', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userId: currentUserId, 
            action: 'approve',
            lista_precios: listaPrecios
          })
        });

        if (res.ok) {
          alert('Usuario aprobado correctamente');
          window.location.reload();
        } else {
          alert('Error al aprobar usuario');
        }
      } catch (error) {
        console.error(error);
        alert('Error al aprobar usuario');
      }
    });
  </script>
</MainLayout>
