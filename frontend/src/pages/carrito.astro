---
import MainLayout from '../layouts/MainLayout.astro';
import CartList from '../components/cart/CartList.jsx';
import { formatCurrency } from '../lib/utils';

const MIN_ORDER_AMOUNT = 35000;
const user = Astro.locals.user;
---

<MainLayout title="Carrito | EcoFort">
  <h1 class="text-2xl font-bold mb-8">Tu Carrito</h1>
  
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8" id="cart-container">
    <div class="lg:col-span-2">
      <CartList client:only="react" />
    </div>
    
    <div class="lg:col-span-1">
      <div class="bg-white p-6 rounded-lg shadow-sm sticky top-4">
        <h2 class="text-lg font-semibold mb-4">Resumen</h2>
        <div class="flex justify-between mb-2">
          <span>Subtotal</span>
          <span id="cart-subtotal">$0</span>
        </div>
        <div class="border-t pt-4 mt-4">
          <div class="flex justify-between font-bold text-lg">
            <span>Total</span>
            <span id="cart-total">$0</span>
          </div>
        </div>
        
        <div id="min-order-warning" class="hidden mt-4 p-3 bg-yellow-100 text-yellow-700 text-sm rounded">
          El monto mínimo de compra es {formatCurrency(MIN_ORDER_AMOUNT)}
        </div>

        <a href="/checkout" id="checkout-btn" class="block w-full bg-blue-600 text-white text-center py-3 rounded mt-6 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
          Proceder al Pago
        </a>
      </div>
    </div>
  </div>

  <script>
    import { cartItems, type CartItem } from '../stores/cartStore';
    import { formatCurrency } from '../lib/utils';

    const MIN_ORDER_AMOUNT = 35000;
    const checkoutBtn = document.getElementById('checkout-btn');
    const warningMsg = document.getElementById('min-order-warning');
    const subtotalEl = document.getElementById('cart-subtotal');
    const totalEl = document.getElementById('cart-total');

    function updateCartSummary() {
      const items = cartItems.get() as CartItem[];
      const total = items.reduce((acc: number, item: CartItem) => acc + (item.precio * item.cantidad), 0);
      
      if (subtotalEl) subtotalEl.textContent = formatCurrency(total);
      if (totalEl) totalEl.textContent = formatCurrency(total);

      if (total < MIN_ORDER_AMOUNT && items.length > 0) {
        checkoutBtn?.setAttribute('disabled', 'true');
        checkoutBtn?.classList.add('pointer-events-none', 'opacity-50');
        warningMsg?.classList.remove('hidden');
      } else {
        checkoutBtn?.removeAttribute('disabled');
        checkoutBtn?.classList.remove('pointer-events-none', 'opacity-50');
        warningMsg?.classList.add('hidden');
      }

      // Si no hay items, deshabilitar también
      if (items.length === 0) {
        checkoutBtn?.setAttribute('disabled', 'true');
        checkoutBtn?.classList.add('pointer-events-none', 'opacity-50');
      }
    }

    // Initial update
    updateCartSummary();
    
    // Subscribe to changes
    cartItems.subscribe(() => updateCartSummary());
  </script>
</MainLayout>
