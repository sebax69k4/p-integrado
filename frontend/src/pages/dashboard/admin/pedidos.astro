---
import MainLayout from '../../../layouts/MainLayout.astro';
import { getAllPedidos } from '../../../lib/strapi';
import { formatCurrency } from '../../../lib/utils';

const token = Astro.cookies.get('jwt')?.value;

let pedidos: any[] = [];
if (token) {
  try {
    pedidos = await getAllPedidos(token);
  } catch (error) {
    console.error('Error fetching orders:', error);
  }
}

const ESTADOS = ['Recibido', 'En preparacion', 'Facturado', 'Despachado'];

const getEstadoColor = (estado: string) => {
  switch (estado) {
    case 'Recibido': return 'bg-yellow-100 text-yellow-800';
    case 'En preparacion': return 'bg-blue-100 text-blue-800';
    case 'Facturado': return 'bg-purple-100 text-purple-800';
    case 'Despachado': return 'bg-green-100 text-green-800';
    default: return 'bg-gray-100 text-gray-800';
  }
};
---

<MainLayout title="Gesti√≥n de Pedidos | Admin">
  <h1 class="text-2xl font-bold mb-8">Panel de Administraci√≥n</h1>
  
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <aside class="space-y-2">
      <a href="/dashboard/admin/validaciones" class="block p-3 hover:bg-gray-50 rounded text-gray-700">
        Validar Usuarios
      </a>
      <a href="/dashboard/admin/pedidos" class="block p-3 bg-blue-50 text-blue-700 rounded font-medium">
        Gestionar Pedidos
      </a>
      <a href="/dashboard/admin/stock" class="block p-3 hover:bg-gray-50 rounded text-gray-700">
        Stock / Laudus
      </a>
      <hr class="my-4" />
      <a href="/dashboard" class="block p-3 hover:bg-gray-50 rounded text-gray-500 text-sm">
        ‚Üê Volver al Dashboard
      </a>
    </aside>
    
    <div class="md:col-span-3">
      <div class="bg-white rounded-lg shadow-sm p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">Todos los Pedidos</h2>
          <a 
            href="/api/admin/exportar-pedidos" 
            class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
          >
            üì• Exportar CSV
          </a>
        </div>
        
        {pedidos.length === 0 ? (
          <div class="text-center py-12">
            <p class="text-gray-500">No hay pedidos registrados.</p>
          </div>
        ) : (
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-3 px-2">Ticket</th>
                  <th class="text-left py-3 px-2">Cliente</th>
                  <th class="text-left py-3 px-2">Total</th>
                  <th class="text-left py-3 px-2">Estado</th>
                  <th class="text-left py-3 px-2">Fecha</th>
                  <th class="text-left py-3 px-2">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {pedidos.map((pedido: any) => (
                  <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-2 font-mono font-bold">{pedido.numero_ticket}</td>
                    <td class="py-3 px-2">
                      <p class="font-medium">{pedido.user?.nombre_empresa || pedido.user?.username}</p>
                      <p class="text-xs text-gray-500">{pedido.user?.email}</p>
                    </td>
                    <td class="py-3 px-2">{formatCurrency(pedido.total)}</td>
                    <td class="py-3 px-2">
                      <span class={`px-2 py-1 rounded-full text-xs font-medium ${getEstadoColor(pedido.estado)}`}>
                        {pedido.estado}
                      </span>
                    </td>
                    <td class="py-3 px-2 text-sm">
                      {new Date(pedido.fecha_pedido || pedido.createdAt).toLocaleDateString('es-CL')}
                    </td>
                    <td class="py-3 px-2">
                      <select
                        data-pedido-id={pedido.id}
                        data-current-estado={pedido.estado}
                        class="estado-select border rounded px-2 py-1 text-sm"
                      >
                        {ESTADOS.map(estado => (
                          <option value={estado} selected={estado === pedido.estado}>
                            {estado}
                          </option>
                        ))}
                      </select>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  </div>
</MainLayout>

<script>
  document.querySelectorAll('.estado-select').forEach(select => {
    select.addEventListener('change', async (e) => {
      const target = e.currentTarget as HTMLSelectElement;
      const pedidoId = target.dataset.pedidoId;
      const nuevoEstado = target.value;
      const estadoAnterior = target.dataset.currentEstado;
      
      if (nuevoEstado === estadoAnterior) return;
      
      try {
        const response = await fetch('/api/admin/actualizar-estado-pedido', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pedidoId, estado: nuevoEstado })
        });
        
        if (response.ok) {
          target.dataset.currentEstado = nuevoEstado;
          // Actualizar color del badge
          const row = target.closest('tr');
          if (row) {
            const badge = row.querySelector('span');
            if (badge) {
              badge.textContent = nuevoEstado;
            }
          }
        } else {
          alert('Error al actualizar el estado');
          target.value = estadoAnterior || '';
        }
      } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
        target.value = estadoAnterior || '';
      }
    });
  });
</script>
