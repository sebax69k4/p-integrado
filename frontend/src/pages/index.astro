---
import MainLayout from '../layouts/MainLayout.astro';
import ProductGrid from '../components/products/ProductGrid.astro';
import CategoryFilter from '../components/products/CategoryFilter.astro';
import fetchApi from '../lib/strapi';

const user = Astro.locals.user;
const showPrice = user?.validado_por_admin ?? false;

// Fetch products from Strapi
let products: any[] = [];
try {
  products = await fetchApi<any[]>({
    endpoint: 'productos',
    wrappedByKey: 'data',
    query: {
      populate: 'imagen'
    }
  }) || [];
  
  if (!Array.isArray(products)) {
    products = [];
  }
} catch (error) {
  console.error("Error fetching products:", error);
  products = [];
}
---

<MainLayout title="CatÃ¡logo | EcoFort">
  <div class="mb-8">
    <h1 class="text-3xl font-bold mb-4">Nuestros Productos</h1>
    <CategoryFilter />
  </div>
  
  {products.length > 0 ? (
    <ProductGrid products={products} showPrice={showPrice} />
  ) : (
    <div class="text-center py-12">
      <p class="text-gray-500">No hay productos disponibles en este momento.</p>
    </div>
  )}
</MainLayout>
