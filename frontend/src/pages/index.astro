---
import MainLayout from '../layouts/MainLayout.astro';
import ProductGrid from '../components/products/ProductGrid.astro';
import CategoryFilter from '../components/products/CategoryFilter.astro';
import fetchApi from '../lib/strapi';
import type { Producto } from '../lib/types';

const user = Astro.locals.user;
const showPrice = user?.validado_por_admin === true;

// Obtener filtro de familia de la URL
const familia = Astro.url.searchParams.get('familia');

// Fetch products from Strapi
let products: Producto[] = [];
try {
  const query: Record<string, string> = {
    'populate': 'imagen',
    'pagination[pageSize]': '100',
  };
  
  // Filtrar por familia si está presente
  if (familia) {
    query['filters[familia][$eq]'] = familia;
  }

  products = await fetchApi<Producto[]>({
    endpoint: 'productos',
    wrappedByKey: 'data',
    query,
  }) || [];
  
  if (!Array.isArray(products)) {
    products = [];
  }
} catch (error) {
  console.error("Error fetching products:", error);
  products = [];
}
const userPriceList = user?.lista_precios || 'estandar';
---

<MainLayout title="Catálogo | EcoFort">
  <div class="mb-8">
    <h1 class="text-3xl font-bold mb-4">Nuestros Productos</h1>
    <CategoryFilter currentFamily={familia} />
  </div>
  
  {products.length > 0 ? (
    <ProductGrid products={products} showPrice={showPrice} priceList={userPriceList} />
  ) : (
    <div class="text-center py-12">
      <p class="text-gray-500">No hay productos disponibles en este momento.</p>
    </div>
  )}
</MainLayout>
